<%- include('../partials/header', { nav: { current: '/films' }, title: 'New Film' }) %>

<div class="container container-narrow py-3">
    <h1 class="h4 mb-3">New Film</h1>

    <% if (errors && errors.length) { %>
        <div class="alert alert-danger"><ul class="mb-0">
                <% errors.forEach(function(e){ %><li><%= e %></li><% }) %>
            </ul></div>
    <% } %>

    <form method="post" action="/films/new">
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input class="form-control" name="title" value="<%= values.title || '' %>">
        </div>
        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" rows="4" name="description"><%= values.description || '' %></textarea>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Language</label>
                <select class="form-select" name="language_id">
                    <option value="">Choose…</option>
                    <% (languages || []).forEach(function(l){ %>
                        <option value="<%= l.language_id %>" <%= +values.language_id === +l.language_id ? 'selected' : '' %>><%= l.name %></option>
                    <% }) %>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Category</label>
                <select class="form-select" name="category_id">
                    <option value="">Choose…</option>
                    <% (categories || []).forEach(function(c){ %>
                        <option value="<%= c.category_id %>" <%= +values.category_id === +c.category_id ? 'selected' : '' %>><%= c.name %></option>
                    <% }) %>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Rental rate (€)</label>
                <input class="form-control" type="number" step="0.01" name="rental_rate" value="<%= values.rental_rate || '0.99' %>">
            </div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-md-4">
                <label class="form-label">Release year</label>
                <input class="form-control" name="release_year" maxlength="4" value="<%= values.release_year || '' %>">
            </div>
            <div class="col-md-4">
                <label class="form-label">Rating</label>
                <select class="form-select" name="rating">
                    <option value="">(none)</option>
                    <% ['G','PG','PG-13','R','NC-17'].forEach(function(r){ %>
                        <option value="<%= r %>" <%= (values.rating || '') === r ? 'selected' : '' %>><%= r %></option>
                    <% }) %>
                </select>
            </div>
        </div>

        <div class="mb-2 mt-3"><label class="form-label">Actors</label></div>
        <div class="input-group mb-2">
            <span class="input-group-text">Search</span>
            <input id="actorFilter" type="text" class="form-control" placeholder="Type to filter actors…">
            <button type="button" id="actorClear" class="btn btn-outline-light">Clear</button>
        </div>
        <select id="actorSelect" class="form-select" name="actor_ids" multiple size="12">
            <% (actors || []).forEach(function(a){ %>
                <option value="<%= a.actor_id %>" <%= (values.actor_ids || []).includes(a.actor_id) ? 'selected' : '' %>><%= a.last_name %>, <%= a.first_name %></option>
            <% }) %>
        </select>
        <small class="text-muted d-block mt-1" id="actorCount"></small>

        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-primary">Save</button>
            <a class="btn btn-outline-light" href="/films">Cancel</a>
        </div>
    </form>
</div>

<script>
    (function(){
        const sel = document.getElementById('actorSelect');
        const inp = document.getElementById('actorFilter');
        const clr = document.getElementById('actorClear');
        const count = document.getElementById('actorCount');
        function refreshCount(){
            const n = Array.from(sel.options).filter(o => o.selected).length;
            count.textContent = n + ' selected';
        }
        function filter(){
            const q = (inp.value || '').toLowerCase();
            Array.from(sel.options).forEach(o => {
                const t = o.textContent.toLowerCase();
                o.hidden = q && !t.includes(q);
            });
        }
        sel.addEventListener('change', refreshCount);
        inp.addEventListener('input', filter);
        clr.addEventListener('click', function(){ inp.value=''; filter(); });
        refreshCount();
    })();
</script>

<%- include('../partials/footer') %>
